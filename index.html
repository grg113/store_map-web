<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>全国门店分布</title>
    <script src="./echarts.min.js"></script>
    <script src="./data.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f4f7f9; }
        #map-container { width: 100vw; height: 100vh; }
        .legend-box { position: absolute; left: 20px; bottom: 30px; z-index: 999; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-family: "Microsoft YaHei"; pointer-events: none; }
        .legend-title { font-weight: bold; margin-bottom: 10px; font-size: 14px; color: #333; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; }
        .legend-color-box { width: 14px; height: 14px; margin-right: 8px; border-radius: 2px; border: 1px solid #ccc; }
        .back-btn { position: absolute; top: 30px; left: 30px; z-index: 1000; background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-family: "Microsoft YaHei"; display: none; }
        /* 加载进度提示 */
        #preload-status { position: absolute; top: 10px; right: 10px; font-size: 12px; color: #999; z-index: 100; pointer-events: none; }
    </style>
</head>
<body>
    <div id="backBtn" class="back-btn" onclick="resetMap()">← 返回全国地图</div>

    <div id="legend-nation" class="legend-box">
        <div class="legend-title">全国门店分布状态</div>
        <div class="legend-item"><div class="legend-color-box" style="background-color: #a9a9a9;"></div><span style="font-size: 12px; color: #666;">无门店区域</span></div>
        <div class="legend-item"><div class="legend-color-box" style="background-color: #ff4d4f;"></div><span style="font-size: 12px; color: #333;">有门店区域 (含直营/加盟)</span></div>
    </div>

    <div id="legend-city" class="legend-box" style="display: none;">
        <div class="legend-title">区域门店类型分布</div>
        <div class="legend-item"><div class="legend-color-box" style="background-color: #a9a9a9;"></div><span style="font-size: 12px; color: #666;">无门店区域</span></div>
        <div class="legend-item"><div class="legend-color-box" style="background-color: #8b0000;"></div><span style="font-size: 12px; color: #333;">直营门店区域</span></div>
        <div class="legend-item"><div class="legend-color-box" style="background-color: #ff7f7f;"></div><span style="font-size: 12px; color: #333;">加盟门店区域</span></div>
    </div>

    <div id="map-container"></div>

    <script>
        var myChart = echarts.init(document.getElementById('map-container'));
        var isProvinceView = false;
        var adcodeMap = {'100000': '中华人民共和国', '110000': '北京市', '120000': '天津市', '130000': '河北省', '140000': '山西省', '150000': '内蒙古自治区', '210000': '辽宁省', '220000': '吉林省', '230000': '黑龙江省', '310000': '上海市', '320000': '江苏省', '330000': '浙江省', '340000': '安徽省', '350000': '福建省', '360000': '江西省', '370000': '山东省', '410000': '河南省', '420000': '湖北省', '430000': '湖南省', '440000': '广东省', '450000': '广西壮族自治区', '460000': '海南省', '500000': '重庆市', '510000': '四川省', '520000': '贵州省', '530000': '云南省', '540000': '西藏自治区', '610000': '陕西省', '620000': '甘肃省', '630000': '青海省', '640000': '宁夏回族自治区', '650000': '新疆维吾尔自治区'};
        var nameToAdcode = {}; for (var code in adcodeMap) nameToAdcode[adcodeMap[code]] = code;

        function getShortName(name) { return name ? name.replace(/(省|市|自治区|壮族|回族|维吾尔|特别行政区|地区|盟)/g, "") : ""; }

        // ================= 核心优化：地图缓存池 =================
        var mapDataCache = {}; 
        var isPreloaded = false;

        // 开始静默预加载
        function startPreload() {
            var codes = Object.keys(adcodeMap).filter(c => c !== '100000'); // 排除全国，只下载省份
            var total = codes.length;
            var count = 0;
            
            codes.forEach(code => {
                fetch(`https://geo.datav.aliyun.com/areas_v3/bound/${code}_full.json`)
                    .then(res => res.json())
                    .then(data => {
                        mapDataCache[code] = data; // 存入缓存
                        count++;
                        // 更新右上角状态
                        if(count === total) {
                            document.getElementById('preload-status').innerText = "地图数据预备完毕";
                            document.getElementById('preload-status').style.color = "#4caf50";
                            setTimeout(() => { document.getElementById('preload-status').style.display = 'none'; }, 2000);
                        } else {
                            document.getElementById('preload-status').innerText = `正在预备地图... ${Math.round((count/total)*100)}%`;
                        }
                    })
                    .catch(err => console.log("预加载失败: " + code));
            });
        }
        // =======================================================

        function renderMap(mapCode, mapName) {
            // 检查缓存里有没有
            if (mapDataCache[mapCode]) {
                // 【有缓存】直接用，无需网络请求 -> 秒开！
                drawMap(mapCode, mapName, mapDataCache[mapCode]);
            } else {
                // 【无缓存】第一次加载全国地图，或者预加载还没完成时，走网络请求
                myChart.showLoading();
                fetch(`https://geo.datav.aliyun.com/areas_v3/bound/${mapCode}_full.json`)
                    .then(res => res.json())
                    .then(geoJson => {
                        myChart.hideLoading();
                        // 1. 修正全国地图的偏移
                        if (mapCode === '100000') {
                            geoJson.features.forEach(f => {
                                var n = f.properties.name;
                                if (n === '河北省') f.properties.cp = [115.5, 38.2];
                                else if (n === '甘肃省') f.properties.cp = [102.5, 38.5];
                                else if (n === '陕西省') f.properties.cp = [108.9, 35.5];
                            });
                            // 第一次加载完全国地图后，立即启动后台预加载
                            if (!isPreloaded) {
                                startPreload();
                                isPreloaded = true;
                            }
                        }
                        // 存入缓存供下次使用
                        mapDataCache[mapCode] = geoJson;
                        drawMap(mapCode, mapName, geoJson);
                    })
                    .catch(err => { myChart.hideLoading(); alert("地图加载超时"); });
            }
        }

        // 具体的绘制逻辑（和之前一样，只是被封装了）
        function drawMap(mapCode, mapName, geoJson) {
            echarts.registerMap(mapName, geoJson);
            var seriesData = [];
            var isNation = mapCode === '100000';
            
            isProvinceView = !isNation;
            document.getElementById('backBtn').style.display = isNation ? 'none' : 'block';
            document.getElementById('legend-nation').style.display = isNation ? 'block' : 'none';
            document.getElementById('legend-city').style.display = isNation ? 'none' : 'block';

            var currentDirectStr = directData[adcodeMap[mapCode]] || "";
            var currentFranchiseStr = franchiseData[adcodeMap[mapCode]] || "";

            geoJson.features.forEach(feature => {
                var n = feature.properties.name;
                
                if(isNation){
                    var hasS = franchiseData[n] || directData[n];
                    seriesData.push({ 
                        name: n, 
                        value: hasS ? 1 : 0, 
                        direct: directData[n], 
                        franchise: franchiseData[n] 
                    });
                } else {
                    var shortCity = getShortName(n);
                    var type = 0;
                    if (currentDirectStr.indexOf(shortCity) !== -1) { type = 2; } 
                    else if (currentFranchiseStr.indexOf(shortCity) !== -1) { type = 1; }
                    seriesData.push({ 
                        name: n, value: type, 
                        pDirect: currentDirectStr, pFranchise: currentFranchiseStr 
                    });
                }
            });

            myChart.setOption({
                title: { text: isNation ? '全国门店分布地图' : mapName + '详情', left: 'center', top: '20' },
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    borderColor: '#333',
                    textStyle: { color: '#fff', fontSize: 13, lineHeight: 20 },
                    padding: 10,
                    formatter: function(p) {
                        var html = `<b>${p.name}</b><br/>`;
                        if(isNation){
                            if(!p.data.direct && !p.data.franchise) return html + "暂无门店";
                            if(p.data.direct) html += `<span style="color:#ff9999">直营门店：</span>${p.data.direct}<br/>`;
                            if(p.data.franchise) html += `<span style="color:#aaddff">加盟门店：</span>${p.data.franchise}`;
                        } else {
                            var typeStr = p.data.value === 2 ? "<span style='color:#ff4d4f;font-weight:bold'>(直营区)</span>" : 
                                          p.data.value === 1 ? "<span style='color:#ff9999;font-weight:bold'>(加盟区)</span>" : "";
                            html += `${typeStr}<br/>`;
                            if(p.data.pDirect) html += `省直营门店：${p.data.pDirect}<br/>`;
                            if(p.data.pFranchise) html += `省加盟门店：${p.data.pFranchise}`;
                            if(!p.data.pDirect && !p.data.pFranchise) html += "该省暂无数据";
                        }
                        return html;
                    }
                },
                visualMap: { 
                    show: false, 
                    pieces: isNation ? 
                        [{value:1, color:'#ff4d4f'}, {value:0, color:'#a9a9a9'}] : 
                        [{value:2, color:'#8b0000'}, {value:1, color:'#ff7f7f'}, {value:0, color:'#a9a9a9'}] 
                },
                geo: {
                    map: mapName, roam: true, zoom: 1.2,
                    center: isNation ? [104.5, 36.5] : null,
                    label: { show: true, color: '#fff', fontSize: 9, formatter: p => getShortName(p.name) },
                    labelLayout: { hideOverlap: true },
                    itemStyle: { areaColor: '#a9a9a9', borderColor: '#fff' },
                    emphasis: { itemStyle: { areaColor: '#ffcc00' } }
                },
                series: [{ type: 'map', geoIndex: 0, data: seriesData }]
            }, true);
        }

        renderMap('100000', 'china');
        myChart.on('click', function(p) {
            if (isProvinceView) return;
            var code = nameToAdcode[p.name] || nameToAdcode[p.name + "省"] || nameToAdcode[p.name + "市"] || nameToAdcode[p.name + "自治区"];
            if (code) renderMap(code, p.name);
        });
        function resetMap() { renderMap('100000', 'china'); }
        window.addEventListener('resize', () => myChart.resize());
    </script>
</body>
</html>